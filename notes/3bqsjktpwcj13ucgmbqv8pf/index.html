<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><link rel="icon" href="/favicon.ico"/><title>Tutorial</title><meta name="robots" content="index,follow"/><meta name="googlebot" content="index,follow"/><meta name="description" content="Personal knowledge space"/><meta property="og:title" content="Tutorial"/><meta property="og:description" content="Personal knowledge space"/><meta property="og:url" content="https://github.io/BershteynLab/wiki-example/notes/3bqsjktpwcj13ucgmbqv8pf/"/><meta property="og:type" content="article"/><meta property="article:published_time" content="3/28/2022"/><meta property="article:modified_time" content="3/28/2022"/><link rel="canonical" href="https://github.io/BershteynLab/wiki-example/notes/3bqsjktpwcj13ucgmbqv8pf/"/><meta name="next-head-count" content="14"/><link rel="preload" href="/wiki-example/_next/static/css/142041e816248e7c.css" as="style"/><link rel="stylesheet" href="/wiki-example/_next/static/css/142041e816248e7c.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/wiki-example/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/wiki-example/_next/static/chunks/webpack-912355ada22b22f3.js" defer=""></script><script src="/wiki-example/_next/static/chunks/framework-4975f770e34de116.js" defer=""></script><script src="/wiki-example/_next/static/chunks/main-6d1bf024b5543728.js" defer=""></script><script src="/wiki-example/_next/static/chunks/pages/_app-0f861e3d89847714.js" defer=""></script><script src="/wiki-example/_next/static/chunks/155-0a8d44b6408c244d.js" defer=""></script><script src="/wiki-example/_next/static/chunks/pages/notes/%5Bid%5D-dc9b1cbe134a7143.js" defer=""></script><script src="/wiki-example/_next/static/TgB2EbN38gblYO5u1ZFBG/_buildManifest.js" defer=""></script><script src="/wiki-example/_next/static/TgB2EbN38gblYO5u1ZFBG/_ssgManifest.js" defer=""></script><script src="/wiki-example/_next/static/TgB2EbN38gblYO5u1ZFBG/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><section class="ant-layout" style="width:100%;min-height:100%"><header class="ant-layout-header" style="position:fixed;isolation:isolate;z-index:1;width:100%;border-bottom:1px solid #d4dadf;height:64px;padding:0 24px 0 2px"><div class="ant-row ant-row-center" style="max-width:992px;justify-content:space-between;margin:0 auto"><div style="display:flex" class="ant-col ant-col-xs-20 ant-col-sm-4"></div><div class="ant-col gutter-row ant-col-xs-0 ant-col-sm-20 ant-col-md-20 ant-col-lg-19"><div class="ant-select ant-select-lg ant-select-auto-complete ant-select-single ant-select-allow-clear ant-select-show-search" style="width:100%"><div class="ant-select-selector"><span class="ant-select-selection-search"><input type="search" autoComplete="off" class="ant-select-selection-search-input" role="combobox" aria-haspopup="listbox" aria-owns="undefined_list" aria-autocomplete="list" aria-controls="undefined_list" aria-activedescendant="undefined_list_0" value=""/></span><span class="ant-select-selection-placeholder">For full text search please use the &#x27;?&#x27; prefix. e.g. ? Onboarding</span></div></div></div><div style="display:none;align-items:center;justify-content:center" class="ant-col ant-col-xs-4 ant-col-sm-4 ant-col-md-0 ant-col-lg-0"><span role="img" aria-label="menu" style="font-size:24px" tabindex="-1" class="anticon anticon-menu"><svg viewBox="64 64 896 896" focusable="false" data-icon="menu" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M904 160H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8zm0 624H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8zm0-312H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8z"></path></svg></span></div></div></header><section class="ant-layout site-layout" style="margin-top:64px"><section class="ant-layout site-layout" style="flex-direction:row"><section class="ant-layout site-layout-sidebar" style="flex:0 0 auto;width:calc(max((100% - 992px) / 2, 0px) + 200px);min-width:200px;padding-left:calc((100% - 992px) / 2)"><aside class="ant-layout-sider ant-layout-sider-dark" style="position:fixed;overflow:auto;height:calc(100vh - 64px);flex:0 0 200px;max-width:200px;min-width:200px;width:200px"><div class="ant-layout-sider-children"></div></aside></section><section class="ant-layout side-layout-main" style="max-width:1200px;display:initial"><main class="ant-layout-content main-content" role="main" style="padding:0 24px"><div class="ant-row"><div class="ant-col ant-col-24"><div class="ant-row" style="margin-left:-10px;margin-right:-10px"><div style="padding-left:10px;padding-right:10px" class="ant-col ant-col-xs-24 ant-col-md-18"><div><h1 id="tutorial"><a aria-hidden="true" class="anchor-heading" href="#tutorial"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Tutorial</h1>
<h1 id="getting-started-with-emod"><a aria-hidden="true" class="anchor-heading" href="#getting-started-with-emod"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Getting Started with EMOD</h1>
<h2 id="introduction"><a aria-hidden="true" class="anchor-heading" href="#introduction"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Introduction</h2>
<p>Welcome to EMOD!</p>
<p>This repository and the documents contained herein are intended to serve as a basic walkthrough of how to install and run EMOD.</p>
<p>We will walk through the steps required to use EMOD and DTK-Tools as a black box software model. The full scope of how to build and customize an EMOD model from scratch will not be covered here.  The next recommended steps for understanding the different features and nuances of the epidemiological model are covered elsewhere.</p>
<p><a href="https://docs.idmod.org/projects/emod-hiv/en/latest/software-overview.html">EMOD Software Overview</a></p>
<h2 id="a-guide-to-the-files-in-this-directory"><a aria-hidden="true" class="anchor-heading" href="#a-guide-to-the-files-in-this-directory"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>A guide to the files in this directory</h2>
<p>The present directory contains the following files and directories:</p>
<ul>
<li><code>simtools.ini</code></li>
<li><code>Data/calibration_ingest_form_Malawi_3_node_AB2_no_inc.xlsm</code> - This is the "ingest file." It contains a great deal of information which the simulation uses as inputs. This includes:
<ul>
<li>the list of dynamic parameters which will be fit during the calibration stage,</li>
<li>the list of calibration target variables and how the calibration stage should weight them</li>
<li>all calibration target data (ie, empirical data used to calibrate the model)</li>
</ul>
</li>
<li><code>InputFiles</code>
<ul>
<li><code>Static/Demographics_Malawi.json</code> - Malawi demographics file; includes all mortality and fertility data</li>
</ul>
</li>
<li><code>InputFiles/Templates</code>
<ul>
<li><code>PFA_Overlay_Malawi.json</code> - Malawi demographics file which adjusts the pair formation algorithm according to likelihood of pair formation between different demographic groups</li>
<li><code>Risk_Assortivity_Overlay_Malawi.json</code> - Malawi demographics file which adjusts assortativity between agents according to risk group (ie, risk-prone agents may be more likely to form pairs with other risk-prone agents)</li>
<li><code>Accessibility_and_Risk_IP_Overlay_Malawi.json</code> - Malawi demographics file which adjusts accessibility and risk</li>
<li><code>campaign_Malawi_1Dec2021_recalib.json</code> - "Campaign file," which defines the full structure of the network of events which occur in the simulation. Together, this network of events describes the events which lead to transmission; the course of infection within infected individuals; and all the different ways individual agents interact with the health care system --- testing, treatment, care, etc.</li>
<li><code>config.json</code> - a (mostly) alphabetical list of all parameters which are defined in the simulation. Not all of these parameters are necessary to build a simulation of HIV, but </li>
</ul>
</li>
<li><code>optim_script.py</code> 
<ul>
<li>Script for configuring the calibration stage of the simulation</li>
</ul>
</li>
<li><code>run_scenarios.py</code>
<ul>
<li>Script for configuring and executing the simulation runs</li>
</ul>
</li>
<li><code>scenarios.csv</code>
<ul>
<li>List of scenarios, which are run as part of <code>run_scenarios</code></li>
</ul>
</li>
</ul>
<p>All together, these files can be used to build and run a simulation of HIV transmission in Malawi using EMOD and DTK-Tools.</p>
<p>It is recommended that you clone this repo in your personal folder in the Bershteyn lab group directory:</p>
<p><code>/gpfs/data/bershteynlab/EMOD/[YOUR FOLDER]</code></p>
<h2 id="steps-for-installing-emod-and-dtk-tools"><a aria-hidden="true" class="anchor-heading" href="#steps-for-installing-emod-and-dtk-tools"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Steps for Installing EMOD and DTK-Tools</h2>
<p>Follow these steps to install EMOD and DTK-Tools on BigPurple (NYU Langone's cluster):</p>
<h3 id="configure-bash-and-python-environment"><a aria-hidden="true" class="anchor-heading" href="#configure-bash-and-python-environment"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Configure bash and python environment</h3>
<ol>
<li><code>ssh</code> into BigPurple</li>
<li>Create a virtual python environment for the purpose of holding all the python packages that DTK-Tools depends on. Run the following in the command line:</li>
</ol>
<pre><code>python -m venv ~/environments/dtk-tools-p36
source ~/environments/dtk-tools-p36/bin/activate
</code></pre>
<ol start="3">
<li>Modify the bash environment to automatically launch the python environment just created. Paste the following into the <code>.bashrc</code> file:</li>
</ol>
<pre><code># .bashrc

# Source global definitions
if [ -f /etc/bashrc ]; then
        . /etc/bashrc
fi

# User specific aliases and functions

module load singularity/3.1
module load python/cpu/3.6.5
module load git/2.17.0

source ~/environments/dtk-tools-p36/bin/activate
export PYTHONPATH=~/environments/dtk-tools-p36/lib/python3.6/site-packages
</code></pre>
<p>Run in command line: <code>source ~/.bashrc</code></p>
<h3 id="install-dtk-tools-and-disease-specific-packages"><a aria-hidden="true" class="anchor-heading" href="#install-dtk-tools-and-disease-specific-packages"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Install DTK-Tools and Disease-Specific Packages</h3>
<p>Use git to install DTK-Tools and packages specific to HIV. It is recommended that you install these in the <code>home</code> directory on BigPurple: `gpfs/home/[YOUR NAME]</p>
<ol>
<li>
<p>Make sure that you have access to the Institute for Disease Modeling's github repos. Both dtk-tools and HIV-Analyzers are private, so your github account must be given permission to view and clone </p>
</li>
<li>
<p>Set up a public key on BigPurple and add the key to github. This will allow you to clone and directly download EMOD and DTK-Tools from github onto BigPurple.</p>
<ul>
<li><a href="https://docs.github.com/en/authentication/connecting-to-github-with-ssh/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent">Generate a new ssh key</a></li>
<li><a href="https://docs.github.com/en/authentication/connecting-to-github-with-ssh/adding-a-new-ssh-key-to-your-github-account">Add your key to your github account</a></li>
</ul>
</li>
<li>
<p>Clone the DTK-Tools repo.
In your <code>home</code> directory on BigPurple, run the following in the command line:</p>
<pre><code>```
cd ~
git clone git@github.com:InstituteforDiseaseModeling/dtk-tools.git dtk-tools-p36
cd dtk-tools-p36
python setup_manual.py
```
</code></pre>
<p>In the command line run <code>dtk -h</code> to confirm installation.</p>
</li>
<li>
<p>Clone the HIV-analyzers repo
In your <code>home</code> directory on BigPurple, run the following in the command line:</p>
<pre><code>```
cd ~
git clone git clone git@github.com:InstituteforDiseaseModeling/HIV-Analyzers.git
cd HIV-Analyzers
python setup.py develop
```
</code></pre>
</li>
<li>
<p>Install Docker image to run simulations.
The Docker image creates a virtual environment where all of the packages and extensions required to run EMOD smoothly already exist. This saves the trouble of needing to re-install and re-configure them. Run the following in the command line:</p>
<pre><code>```
cd ~
mkdir images
cd images
singularity pull docker://idm-docker-public.packages.idmod.org/nyu/dtk:20200306
```
</code></pre>
</li>
</ol>
<h2 id="guide-to-simulation-setup"><a aria-hidden="true" class="anchor-heading" href="#guide-to-simulation-setup"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Guide to Simulation Setup</h2>
<p>The <code>simtools.ini</code> file defines the paths where the simulation looks for inputs and writes outputs.</p>
<p>It is recommended practice to store simulation outputs in the <code>scratch</code> directory on BigPurple. This is a private directory which can be used for temporary storage. In <code>simtools.ini</code>, set the simulation root path to this location:</p>
<pre><code>```
# Path where the experiment/simulation outputs will be stored
sim_root = /gpfs/scratch/[YOUR NAME]/experiments`
```
</code></pre>
<p>Set the <code>input_root</code> as the path to the current directory</p>
<pre><code>```
input_root = /gpfs/data/bershteynlab/EMOD/[YOUR FOLDER]/malawi2022_tutorial/InputFiles/Static
```
</code></pre>
<h2 id="how-to-calibrate"><a aria-hidden="true" class="anchor-heading" href="#how-to-calibrate"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>How to calibrate</h2>
<p>The first stage of the simulation will be to calibrate the model. This process will determine a probability distribution for each of the model parameters designated as "dynamic" which will then be used to run the simulation and produce output.</p>
<ol>
<li>Open a virtual environment with <code>screen</code></li>
<li>Request a compute node on BigPurple: 
<ul>
<li><code>srun -p cpu_short -n 2 --mem-per-cpu=8G --time=11:00:00 --pty bash</code> </li>
<li>More documentation on how to configure the different parts of this command <a href="https://hpcmed.org/guide/slurm">here</a></li>
</ul>
</li>
<li>Run in command line: <code>python optim_script.py</code></li>
</ol>
<p>After the simulation runs, a number of new files will appear:</p>
<ul>
<li>A directory called <code>Malawi--0.001--rep3--test0</code>
<ul>
<li>Contains all of the outputs of each of 10 iterations performed by the simulation (<code>iter0</code>, <code>iter1</code>, etc)</li>
<li>Inside each <code>iter</code> folder is a set of PDF outputs which record the log-likelihood distribution of each dynamic parameter, and shows how the maximum likelihood parameter value evolves over the course of each iteration during calibration.</li>
</ul>
</li>
<li>Can be ignored:
<ul>
<li><code>post_channel_config.json</code> 
<ul>
<li>This defines how the simulation population is subdivided demographically in order to match each demographic subgroup to its corresponding calibration target. A schema for the simulation output.</li>
</ul>
</li>
<li><code>output</code>
<ul>
<li>A directory which contains a number of <code>HIVCalibSite</code> .csv files.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="how-to-run-a-scenario"><a aria-hidden="true" class="anchor-heading" href="#how-to-run-a-scenario"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>How to run a scenario</h2>
<p>The second stage of the simulation will be to run an ensemble of simulations. The simulation will draw from the calibrated parameter values from the previous stage and produce model output which may then be analyzed and interpreted.</p>
<p>Run the following python command inside the compute node on BigPurple:</p>
<pre><code>```
python run_scenarios.py -c optim_script.py --resample-method roulette --nsamples 25 --output-dir MWI_baseline --suite-name MWI_baseline --table scenarios.csv --calib-dir Malawi--0.001--rep3--test0
```
</code></pre>
<ul>
<li><code>-c</code> and <code>--calib-dir</code> : The command references the script used to perform the calibration (<code>optim_script.py</code> and the directory where the calibration results were stored.) </li>
<li><code>--resample-method</code> and <code>--nsamples</code> : The command allows the user to define how the parameter values will be resampled, and the number of times to resample each parameter</li>
<li><code>--table</code> : The user provides a table of scenarios to run. In this case, only the baseline will run.</li>
<li>--output-dir`: Where simulation outputs will go</li>
</ul>
<p>After the simulation runs, a number of new files and directories will appear. The output directory will contain a set of reports. These reports will also appear in the <code>sim_root</code> directory defined in <code>simtools.ini</code></p>
<hr>
<strong>Backlinks</strong>
<ul>
<li><a href="/wiki-example/notes/nxgljwfd9usje6u5rr7fttg">Emod</a></li>
</ul></div></div><div style="padding-left:10px;padding-right:10px" class="ant-col ant-col-xs-0 ant-col-md-6"><div><div class=""><div class="ant-anchor-wrapper dendron-toc" style="max-height:calc(100vh - 64px);z-index:1"><div class="ant-anchor"><div class="ant-anchor-ink"><span class="ant-anchor-ink-ball"></span></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#getting-started-with-emod" title="Getting Started with EMOD">Getting Started with EMOD</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#introduction" title="Introduction">Introduction</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#a-guide-to-the-files-in-this-directory" title="A guide to the files in this directory">A guide to the files in this directory</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#steps-for-installing-emod-and-dtk-tools" title="Steps for Installing EMOD and DTK-Tools">Steps for Installing EMOD and DTK-Tools</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#configure-bash-and-python-environment" title="Configure bash and python environment">Configure bash and python environment</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#install-dtk-tools-and-disease-specific-packages" title="Install DTK-Tools and Disease-Specific Packages">Install DTK-Tools and Disease-Specific Packages</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#guide-to-simulation-setup" title="Guide to Simulation Setup">Guide to Simulation Setup</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#how-to-calibrate" title="How to calibrate">How to calibrate</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#how-to-run-a-scenario" title="How to run a scenario">How to run a scenario</a></div></div></div></div></div></div></div></div></div></main><div class="ant-divider ant-divider-horizontal" role="separator"></div><footer class="ant-layout-footer" style="padding:0 24px 24px"></footer></section></section></section></section></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"note":{"id":"3bqsjktpwcj13ucgmbqv8pf","title":"Tutorial","desc":"","updated":1648478655478,"created":1648478655478,"custom":{},"fname":"emod.tutorial","type":"note","vault":{"fsPath":"vault"},"contentHash":"e4a672917a2b56ca7f631b9dd54ab3be","links":[{"from":{"fname":"emod","vaultName":"vault"},"type":"backlink","position":{"start":{"line":16,"column":1,"offset":202},"end":{"line":16,"column":32,"offset":233},"indent":[]},"value":"emod.tutorial","alias":"EMOD Tutorial"}],"anchors":{"getting-started-with-emod":{"type":"header","text":"Getting Started with EMOD","value":"getting-started-with-emod","line":8,"column":0,"depth":1},"introduction":{"type":"header","text":"Introduction","value":"introduction","line":10,"column":0,"depth":2},"a-guide-to-the-files-in-this-directory":{"type":"header","text":"A guide to the files in this directory","value":"a-guide-to-the-files-in-this-directory","line":20,"column":0,"depth":2},"steps-for-installing-emod-and-dtk-tools":{"type":"header","text":"Steps for Installing EMOD and DTK-Tools","value":"steps-for-installing-emod-and-dtk-tools","line":50,"column":0,"depth":2},"configure-bash-and-python-environment":{"type":"header","text":"Configure bash and python environment","value":"configure-bash-and-python-environment","line":54,"column":0,"depth":3},"install-dtk-tools-and-disease-specific-packages":{"type":"header","text":"Install DTK-Tools and Disease-Specific Packages","value":"install-dtk-tools-and-disease-specific-packages","line":86,"column":0,"depth":3},"guide-to-simulation-setup":{"type":"header","text":"Guide to Simulation Setup","value":"guide-to-simulation-setup","line":124,"column":0,"depth":2},"how-to-calibrate":{"type":"header","text":"How to calibrate","value":"how-to-calibrate","line":141,"column":0,"depth":2},"how-to-run-a-scenario":{"type":"header","text":"How to run a scenario","value":"how-to-run-a-scenario","line":161,"column":0,"depth":2}},"children":[],"parent":"nxgljwfd9usje6u5rr7fttg","data":{}},"body":"\u003ch1 id=\"tutorial\"\u003e\u003ca aria-hidden=\"true\" class=\"anchor-heading\" href=\"#tutorial\"\u003e\u003csvg aria-hidden=\"true\" viewBox=\"0 0 16 16\"\u003e\u003cuse xlink:href=\"#svg-link\"\u003e\u003c/use\u003e\u003c/svg\u003e\u003c/a\u003eTutorial\u003c/h1\u003e\n\u003ch1 id=\"getting-started-with-emod\"\u003e\u003ca aria-hidden=\"true\" class=\"anchor-heading\" href=\"#getting-started-with-emod\"\u003e\u003csvg aria-hidden=\"true\" viewBox=\"0 0 16 16\"\u003e\u003cuse xlink:href=\"#svg-link\"\u003e\u003c/use\u003e\u003c/svg\u003e\u003c/a\u003eGetting Started with EMOD\u003c/h1\u003e\n\u003ch2 id=\"introduction\"\u003e\u003ca aria-hidden=\"true\" class=\"anchor-heading\" href=\"#introduction\"\u003e\u003csvg aria-hidden=\"true\" viewBox=\"0 0 16 16\"\u003e\u003cuse xlink:href=\"#svg-link\"\u003e\u003c/use\u003e\u003c/svg\u003e\u003c/a\u003eIntroduction\u003c/h2\u003e\n\u003cp\u003eWelcome to EMOD!\u003c/p\u003e\n\u003cp\u003eThis repository and the documents contained herein are intended to serve as a basic walkthrough of how to install and run EMOD.\u003c/p\u003e\n\u003cp\u003eWe will walk through the steps required to use EMOD and DTK-Tools as a black box software model. The full scope of how to build and customize an EMOD model from scratch will not be covered here.  The next recommended steps for understanding the different features and nuances of the epidemiological model are covered elsewhere.\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://docs.idmod.org/projects/emod-hiv/en/latest/software-overview.html\"\u003eEMOD Software Overview\u003c/a\u003e\u003c/p\u003e\n\u003ch2 id=\"a-guide-to-the-files-in-this-directory\"\u003e\u003ca aria-hidden=\"true\" class=\"anchor-heading\" href=\"#a-guide-to-the-files-in-this-directory\"\u003e\u003csvg aria-hidden=\"true\" viewBox=\"0 0 16 16\"\u003e\u003cuse xlink:href=\"#svg-link\"\u003e\u003c/use\u003e\u003c/svg\u003e\u003c/a\u003eA guide to the files in this directory\u003c/h2\u003e\n\u003cp\u003eThe present directory contains the following files and directories:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003esimtools.ini\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eData/calibration_ingest_form_Malawi_3_node_AB2_no_inc.xlsm\u003c/code\u003e - This is the \"ingest file.\" It contains a great deal of information which the simulation uses as inputs. This includes:\n\u003cul\u003e\n\u003cli\u003ethe list of dynamic parameters which will be fit during the calibration stage,\u003c/li\u003e\n\u003cli\u003ethe list of calibration target variables and how the calibration stage should weight them\u003c/li\u003e\n\u003cli\u003eall calibration target data (ie, empirical data used to calibrate the model)\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eInputFiles\u003c/code\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003eStatic/Demographics_Malawi.json\u003c/code\u003e - Malawi demographics file; includes all mortality and fertility data\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eInputFiles/Templates\u003c/code\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003ePFA_Overlay_Malawi.json\u003c/code\u003e - Malawi demographics file which adjusts the pair formation algorithm according to likelihood of pair formation between different demographic groups\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eRisk_Assortivity_Overlay_Malawi.json\u003c/code\u003e - Malawi demographics file which adjusts assortativity between agents according to risk group (ie, risk-prone agents may be more likely to form pairs with other risk-prone agents)\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eAccessibility_and_Risk_IP_Overlay_Malawi.json\u003c/code\u003e - Malawi demographics file which adjusts accessibility and risk\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003ecampaign_Malawi_1Dec2021_recalib.json\u003c/code\u003e - \"Campaign file,\" which defines the full structure of the network of events which occur in the simulation. Together, this network of events describes the events which lead to transmission; the course of infection within infected individuals; and all the different ways individual agents interact with the health care system --- testing, treatment, care, etc.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003econfig.json\u003c/code\u003e - a (mostly) alphabetical list of all parameters which are defined in the simulation. Not all of these parameters are necessary to build a simulation of HIV, but \u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eoptim_script.py\u003c/code\u003e \n\u003cul\u003e\n\u003cli\u003eScript for configuring the calibration stage of the simulation\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003erun_scenarios.py\u003c/code\u003e\n\u003cul\u003e\n\u003cli\u003eScript for configuring and executing the simulation runs\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003escenarios.csv\u003c/code\u003e\n\u003cul\u003e\n\u003cli\u003eList of scenarios, which are run as part of \u003ccode\u003erun_scenarios\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eAll together, these files can be used to build and run a simulation of HIV transmission in Malawi using EMOD and DTK-Tools.\u003c/p\u003e\n\u003cp\u003eIt is recommended that you clone this repo in your personal folder in the Bershteyn lab group directory:\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e/gpfs/data/bershteynlab/EMOD/[YOUR FOLDER]\u003c/code\u003e\u003c/p\u003e\n\u003ch2 id=\"steps-for-installing-emod-and-dtk-tools\"\u003e\u003ca aria-hidden=\"true\" class=\"anchor-heading\" href=\"#steps-for-installing-emod-and-dtk-tools\"\u003e\u003csvg aria-hidden=\"true\" viewBox=\"0 0 16 16\"\u003e\u003cuse xlink:href=\"#svg-link\"\u003e\u003c/use\u003e\u003c/svg\u003e\u003c/a\u003eSteps for Installing EMOD and DTK-Tools\u003c/h2\u003e\n\u003cp\u003eFollow these steps to install EMOD and DTK-Tools on BigPurple (NYU Langone's cluster):\u003c/p\u003e\n\u003ch3 id=\"configure-bash-and-python-environment\"\u003e\u003ca aria-hidden=\"true\" class=\"anchor-heading\" href=\"#configure-bash-and-python-environment\"\u003e\u003csvg aria-hidden=\"true\" viewBox=\"0 0 16 16\"\u003e\u003cuse xlink:href=\"#svg-link\"\u003e\u003c/use\u003e\u003c/svg\u003e\u003c/a\u003eConfigure bash and python environment\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003e\u003ccode\u003essh\u003c/code\u003e into BigPurple\u003c/li\u003e\n\u003cli\u003eCreate a virtual python environment for the purpose of holding all the python packages that DTK-Tools depends on. Run the following in the command line:\u003c/li\u003e\n\u003c/ol\u003e\n\u003cpre\u003e\u003ccode\u003epython -m venv ~/environments/dtk-tools-p36\nsource ~/environments/dtk-tools-p36/bin/activate\n\u003c/code\u003e\u003c/pre\u003e\n\u003col start=\"3\"\u003e\n\u003cli\u003eModify the bash environment to automatically launch the python environment just created. Paste the following into the \u003ccode\u003e.bashrc\u003c/code\u003e file:\u003c/li\u003e\n\u003c/ol\u003e\n\u003cpre\u003e\u003ccode\u003e# .bashrc\n\n# Source global definitions\nif [ -f /etc/bashrc ]; then\n        . /etc/bashrc\nfi\n\n# User specific aliases and functions\n\nmodule load singularity/3.1\nmodule load python/cpu/3.6.5\nmodule load git/2.17.0\n\nsource ~/environments/dtk-tools-p36/bin/activate\nexport PYTHONPATH=~/environments/dtk-tools-p36/lib/python3.6/site-packages\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eRun in command line: \u003ccode\u003esource ~/.bashrc\u003c/code\u003e\u003c/p\u003e\n\u003ch3 id=\"install-dtk-tools-and-disease-specific-packages\"\u003e\u003ca aria-hidden=\"true\" class=\"anchor-heading\" href=\"#install-dtk-tools-and-disease-specific-packages\"\u003e\u003csvg aria-hidden=\"true\" viewBox=\"0 0 16 16\"\u003e\u003cuse xlink:href=\"#svg-link\"\u003e\u003c/use\u003e\u003c/svg\u003e\u003c/a\u003eInstall DTK-Tools and Disease-Specific Packages\u003c/h3\u003e\n\u003cp\u003eUse git to install DTK-Tools and packages specific to HIV. It is recommended that you install these in the \u003ccode\u003ehome\u003c/code\u003e directory on BigPurple: `gpfs/home/[YOUR NAME]\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003eMake sure that you have access to the Institute for Disease Modeling's github repos. Both dtk-tools and HIV-Analyzers are private, so your github account must be given permission to view and clone \u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eSet up a public key on BigPurple and add the key to github. This will allow you to clone and directly download EMOD and DTK-Tools from github onto BigPurple.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://docs.github.com/en/authentication/connecting-to-github-with-ssh/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent\"\u003eGenerate a new ssh key\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://docs.github.com/en/authentication/connecting-to-github-with-ssh/adding-a-new-ssh-key-to-your-github-account\"\u003eAdd your key to your github account\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eClone the DTK-Tools repo.\nIn your \u003ccode\u003ehome\u003c/code\u003e directory on BigPurple, run the following in the command line:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e```\ncd ~\ngit clone git@github.com:InstituteforDiseaseModeling/dtk-tools.git dtk-tools-p36\ncd dtk-tools-p36\npython setup_manual.py\n```\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eIn the command line run \u003ccode\u003edtk -h\u003c/code\u003e to confirm installation.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eClone the HIV-analyzers repo\nIn your \u003ccode\u003ehome\u003c/code\u003e directory on BigPurple, run the following in the command line:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e```\ncd ~\ngit clone git clone git@github.com:InstituteforDiseaseModeling/HIV-Analyzers.git\ncd HIV-Analyzers\npython setup.py develop\n```\n\u003c/code\u003e\u003c/pre\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eInstall Docker image to run simulations.\nThe Docker image creates a virtual environment where all of the packages and extensions required to run EMOD smoothly already exist. This saves the trouble of needing to re-install and re-configure them. Run the following in the command line:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e```\ncd ~\nmkdir images\ncd images\nsingularity pull docker://idm-docker-public.packages.idmod.org/nyu/dtk:20200306\n```\n\u003c/code\u003e\u003c/pre\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2 id=\"guide-to-simulation-setup\"\u003e\u003ca aria-hidden=\"true\" class=\"anchor-heading\" href=\"#guide-to-simulation-setup\"\u003e\u003csvg aria-hidden=\"true\" viewBox=\"0 0 16 16\"\u003e\u003cuse xlink:href=\"#svg-link\"\u003e\u003c/use\u003e\u003c/svg\u003e\u003c/a\u003eGuide to Simulation Setup\u003c/h2\u003e\n\u003cp\u003eThe \u003ccode\u003esimtools.ini\u003c/code\u003e file defines the paths where the simulation looks for inputs and writes outputs.\u003c/p\u003e\n\u003cp\u003eIt is recommended practice to store simulation outputs in the \u003ccode\u003escratch\u003c/code\u003e directory on BigPurple. This is a private directory which can be used for temporary storage. In \u003ccode\u003esimtools.ini\u003c/code\u003e, set the simulation root path to this location:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e```\n# Path where the experiment/simulation outputs will be stored\nsim_root = /gpfs/scratch/[YOUR NAME]/experiments`\n```\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eSet the \u003ccode\u003einput_root\u003c/code\u003e as the path to the current directory\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e```\ninput_root = /gpfs/data/bershteynlab/EMOD/[YOUR FOLDER]/malawi2022_tutorial/InputFiles/Static\n```\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2 id=\"how-to-calibrate\"\u003e\u003ca aria-hidden=\"true\" class=\"anchor-heading\" href=\"#how-to-calibrate\"\u003e\u003csvg aria-hidden=\"true\" viewBox=\"0 0 16 16\"\u003e\u003cuse xlink:href=\"#svg-link\"\u003e\u003c/use\u003e\u003c/svg\u003e\u003c/a\u003eHow to calibrate\u003c/h2\u003e\n\u003cp\u003eThe first stage of the simulation will be to calibrate the model. This process will determine a probability distribution for each of the model parameters designated as \"dynamic\" which will then be used to run the simulation and produce output.\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eOpen a virtual environment with \u003ccode\u003escreen\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eRequest a compute node on BigPurple: \n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003esrun -p cpu_short -n 2 --mem-per-cpu=8G --time=11:00:00 --pty bash\u003c/code\u003e \u003c/li\u003e\n\u003cli\u003eMore documentation on how to configure the different parts of this command \u003ca href=\"https://hpcmed.org/guide/slurm\"\u003ehere\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eRun in command line: \u003ccode\u003epython optim_script.py\u003c/code\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eAfter the simulation runs, a number of new files will appear:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eA directory called \u003ccode\u003eMalawi--0.001--rep3--test0\u003c/code\u003e\n\u003cul\u003e\n\u003cli\u003eContains all of the outputs of each of 10 iterations performed by the simulation (\u003ccode\u003eiter0\u003c/code\u003e, \u003ccode\u003eiter1\u003c/code\u003e, etc)\u003c/li\u003e\n\u003cli\u003eInside each \u003ccode\u003eiter\u003c/code\u003e folder is a set of PDF outputs which record the log-likelihood distribution of each dynamic parameter, and shows how the maximum likelihood parameter value evolves over the course of each iteration during calibration.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eCan be ignored:\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003epost_channel_config.json\u003c/code\u003e \n\u003cul\u003e\n\u003cli\u003eThis defines how the simulation population is subdivided demographically in order to match each demographic subgroup to its corresponding calibration target. A schema for the simulation output.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eoutput\u003c/code\u003e\n\u003cul\u003e\n\u003cli\u003eA directory which contains a number of \u003ccode\u003eHIVCalibSite\u003c/code\u003e .csv files.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"how-to-run-a-scenario\"\u003e\u003ca aria-hidden=\"true\" class=\"anchor-heading\" href=\"#how-to-run-a-scenario\"\u003e\u003csvg aria-hidden=\"true\" viewBox=\"0 0 16 16\"\u003e\u003cuse xlink:href=\"#svg-link\"\u003e\u003c/use\u003e\u003c/svg\u003e\u003c/a\u003eHow to run a scenario\u003c/h2\u003e\n\u003cp\u003eThe second stage of the simulation will be to run an ensemble of simulations. The simulation will draw from the calibrated parameter values from the previous stage and produce model output which may then be analyzed and interpreted.\u003c/p\u003e\n\u003cp\u003eRun the following python command inside the compute node on BigPurple:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e```\npython run_scenarios.py -c optim_script.py --resample-method roulette --nsamples 25 --output-dir MWI_baseline --suite-name MWI_baseline --table scenarios.csv --calib-dir Malawi--0.001--rep3--test0\n```\n\u003c/code\u003e\u003c/pre\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003e-c\u003c/code\u003e and \u003ccode\u003e--calib-dir\u003c/code\u003e : The command references the script used to perform the calibration (\u003ccode\u003eoptim_script.py\u003c/code\u003e and the directory where the calibration results were stored.) \u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e--resample-method\u003c/code\u003e and \u003ccode\u003e--nsamples\u003c/code\u003e : The command allows the user to define how the parameter values will be resampled, and the number of times to resample each parameter\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e--table\u003c/code\u003e : The user provides a table of scenarios to run. In this case, only the baseline will run.\u003c/li\u003e\n\u003cli\u003e--output-dir`: Where simulation outputs will go\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eAfter the simulation runs, a number of new files and directories will appear. The output directory will contain a set of reports. These reports will also appear in the \u003ccode\u003esim_root\u003c/code\u003e directory defined in \u003ccode\u003esimtools.ini\u003c/code\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003cstrong\u003eBacklinks\u003c/strong\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"/wiki-example/notes/nxgljwfd9usje6u5rr7fttg\"\u003eEmod\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e","noteIndex":{"id":"wn8PE1RhG0znK1alrGFYv","title":"Root","desc":"","updated":1645566125381,"created":1631901573363,"custom":{"nav_order":0,"permalink":"/"},"fname":"root","type":"note","vault":{"fsPath":"vault"},"contentHash":"1971199a59e3bbb0557f0796998092ae","links":[{"type":"wiki","from":{"fname":"root","id":"wn8PE1RhG0znK1alrGFYv","vaultName":"vault"},"value":"emod","alias":"EMOD usage","position":{"start":{"line":5,"column":3,"offset":173},"end":{"line":5,"column":22,"offset":192},"indent":[]},"xvault":false,"sameFile":false,"to":{"fname":"emod"}},{"type":"wiki","from":{"fname":"root","id":"wn8PE1RhG0znK1alrGFYv","vaultName":"vault"},"value":"hiv","alias":"HIV","position":{"start":{"line":7,"column":5,"offset":212},"end":{"line":7,"column":16,"offset":223},"indent":[]},"xvault":false,"sameFile":false,"to":{"fname":"hiv"}}],"anchors":{"group-wiki":{"type":"header","text":"Group Wiki","value":"group-wiki","line":7,"column":0,"depth":1}},"children":["nxgljwfd9usje6u5rr7fttg","gxe214k84fqq1idy20ruwcy"],"parent":null,"data":{},"body":"# Group Wiki\n\nHi everyone! I wanted to share this prototype group wiki with everyone. This is one way that we might create a centralized repository documenting our work.\n\n* [[EMOD usage|emod]]\n* Epidemiology\n  * [[HIV|hiv]]\n  * Malaria\n\n\u003e This website is generated by a Dendron template. For more information, see the [template README file](https://github.com/dendronhq/template.publish.github-action/). Feel free to modify and delete this section."},"collectionChildren":null,"customHeadContent":null,"config":{"version":5,"dev":{"enablePreviewV2":true},"commands":{"lookup":{"note":{"selectionMode":"extract","confirmVaultOnCreate":false,"leaveTrace":false,"bubbleUpCreateNew":true,"fuzzThreshold":0.2,"vaultSelectionModeOnCreate":"smart"}},"insertNote":{"initialValue":"templates"},"insertNoteLink":{"aliasMode":"none","enableMultiSelect":false},"insertNoteIndex":{"enableMarker":false},"randomNote":{},"copyNoteLink":{}},"workspace":{"vaults":[{"fsPath":"vault"}],"journal":{"dailyDomain":"daily","name":"journal","dateFormat":"y.MM.dd","addBehavior":"childOfDomain"},"scratch":{"name":"scratch","dateFormat":"y.MM.dd.HHmmss","addBehavior":"asOwnDomain"},"graph":{"zoomSpeed":1},"enableAutoCreateOnDefinition":false,"enableXVaultWikiLink":false,"enableRemoteVaultInit":true,"workspaceVaultSyncMode":"noCommit","enableAutoFoldFrontmatter":true,"maxPreviewsCached":10,"maxNoteLength":204800,"task":{"name":"","dateFormat":"","addBehavior":"childOfCurrent","statusSymbols":{"":" ","wip":"w","done":"x","assigned":"a","moved":"m","blocked":"b","delegated":"l","dropped":"d","pending":"y"},"prioritySymbols":{"H":"high","M":"medium","L":"low"},"todoIntegration":false,"createTaskSelectionType":"selection2link"},"enableUserTags":true,"enableHashTags":true,"dendronVersion":"0.83.0","enableEditorDecorations":true},"preview":{"enableFMTitle":true,"enableNoteTitleForLink":true,"enableMermaid":true,"enablePrettyRefs":true,"enableKatex":true,"automaticallyShowPreview":false,"enableFrontmatterTags":true,"enableHashesForFMTags":false},"publishing":{"enableFMTitle":true,"enableNoteTitleForLink":true,"enableMermaid":true,"enablePrettyRefs":true,"enableKatex":true,"assetsPrefix":"/wiki-example","copyAssets":true,"siteHierarchies":["root"],"enableSiteLastModified":true,"siteRootDir":"docs","siteUrl":"https://github.io/BershteynLab","enableFrontmatterTags":true,"enableHashesForFMTags":false,"enableRandomlyColoredTags":true,"duplicateNoteBehavior":{"action":"useVault","payload":["vault"]},"writeStubs":false,"seo":{"title":"Dendron","description":"Personal knowledge space"},"github":{"enableEditLink":true,"editLinkText":"Edit this page on GitHub","editBranch":"main","editViewMode":"tree"},"enablePrettyLinks":true,"siteFaviconPath":"favicon.ico","siteIndex":"root"}}},"__N_SSG":true},"page":"/notes/[id]","query":{"id":"3bqsjktpwcj13ucgmbqv8pf"},"buildId":"TgB2EbN38gblYO5u1ZFBG","assetPrefix":"/wiki-example","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>